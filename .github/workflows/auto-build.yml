name: Build & Release macOS App

on:
  push:
    tags:
      - 'v*' # Trigger on version tags like v1.0.0

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    env:
      GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3

      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: üß± Build .app
        run: |
          xcodebuild -scheme InjectHub \
                     -project InjectHub.xcodeproj \
                     -configuration Release \
                     -derivedDataPath build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO

      - name: üì¶ Zip the .app
        run: |
          mkdir -p release
          APP_PATH=$(find build/Build/Products/Release -name "*.app" -maxdepth 1 | head -n 1)
          echo "App found at: $APP_PATH"
          cp -R "$APP_PATH" ./release/InjectHub.app
          pushd release > /dev/null
          zip -r InjectHub.zip InjectHub.app
          popd > /dev/null

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/InjectHub.zip

      - name: üß∞ Install GitHub CLI
        run: brew install gh

      - name: üß† Extract version & build from Info.plist
        id: versioninfo
        run: |
          VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" InjectHub/Info.plist)
          BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" InjectHub/Info.plist)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT

      - name: üìù Fetch release notes from GitHub
        id: releasenotes
        run: |
          RELEASE_NOTES=$(gh release view "${{ github.ref_name }}" --json body -q '.body')
          echo "$RELEASE_NOTES" > release_notes.txt
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üîÑ Generate update.json
        run: |
          cat <<EOF > update.json
          {
            "version": "${{ steps.versioninfo.outputs.version }}",
            "build": "${{ steps.versioninfo.outputs.build }}",
            "notes": "${{ steps.releasenotes.outputs.notes }}",
            "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/InjectHub.zip"
          }
          EOF

      - name: üìù Commit update.json to main
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
          git fetch origin main
          git checkout main
          git pull origin main
      
          mv update.json update.json
          git add update.json
          git commit -m "üîÑ Update update.json for version ${{ steps.versioninfo.outputs.version }}"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Upload update.json to release assets (or push to a repo/branch/gh-pages)
      # - name: ‚¨ÜÔ∏è Upload update.json to release
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     files: |
      #       release/InjectHub.zip
      #       update.json

